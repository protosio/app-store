version: "3"
services:
  postgres:
    image: postgres:10.5
    volumes:
      - /mnt/protos_volumes/volumes/app-store/pg-data:/var/lib/postgresql/data
    environment:
      - POSTGRES_PASSWORD=${APPSTORE_POSTGRES_PASSWD}
      - POSTGRES_USER=${APPSTORE_POSTGRES_USER}
    networks:
      - backend
    restart: unless-stopped
  docker-registry:
    image: registry:2
    volumes:
      - /mnt/protos_volumes/volumes/app-store/registry-data:/var/lib/registry
      - /mnt/protos_volumes/volumes/app-store/registry-config.yml:/etc/docker/registry/config.yml
    networks:
      - backend
    expose:
      - 5000
    command: ["serve", "/etc/docker/registry/config.yml"]
    restart: unless-stopped
  app-store:
    image: app-store
    volumes:
      - /mnt/protos_volumes/volumes/app-store/app-store-src:/go/src/github.com/protosio/app-store
    networks:
      - backend
    entrypoint: go run /go/src/github.com/protosio/app-store/main.go --dbhost postgres --dbuser ${APPSTORE_POSTGRES_USER} --dbpass ${APPSTORE_POSTGRES_PASSWD} --dbname ${APPSTORE_POSTGRES_USER}
    command: ["serve"]
    depends_on:
      - postgres
      - docker-registry
    expose:
      - 8000
    restart: unless-stopped

networks:
  backend:
